@page "/forwarding-letter"

@using Web_JbcHrms.Models
@using CsvHelper
@using System.Globalization
@using System.IO
@using System.Linq
@using System.Text.Json
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IDisposable

<h3>Forwarding Letter</h3>

@if (!string.IsNullOrEmpty(importError))
{
    <div class="alert alert-danger">@importError</div>
} 

<div class="mb-3">
    <input type="file" id="@FileInputId" accept=".csv" style="display:none" @onchange="HandleFileChange" />

    @if (employees == null)
    {
        <button @onclick="ChooseFile" class="btn btn-primary">Choose File</button>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <button class="btn btn-outline-primary me-2" @onclick="ToggleAllCheckboxes">
                    @(allChecked ? "Uncheck All" : "Check All")
                </button>
            </div>
            <div>
                <button class="btn btn-success" @onclick="PrintSelectedLetters" disabled="@(!selectedEmployees.Any())">
                    <i class="bi bi-printer"></i> Print Selected (@selectedEmployees.Count)
                </button>
            </div>
        </div>
    }
</div>

@if (employees != null && employees.Any())
{
    <div class="table-responsive">
        <table id="accountLetterTable" class="table table-striped table-bordered table-hover w-100">
            <thead class="table-dark">
                <tr>
                    <th class="checkbox-cell">
                        <input hidden type="checkbox" @bind="allChecked" />
                    </th>
                    <th>Name</th>
                    <th>Designation</th>
                    <th>Joining Date</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var emp in employees)
                {
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" class="custom-checkbox" checked="@GetEmployeeSelection(emp)" @onchange="e => HandleCheckboxChange(emp, e)" />
                        </td>
                        <td>@emp.Salutation @emp.FirstName @emp.LastName</td>
                        <td>@emp.Designation</td>
                        <td>@emp.JoiningDate.ToString("yyyy/MM/dd")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

 
<div class="modal fade" id="printPreviewModal" tabindex="-1" aria-labelledby="printPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="printPreviewModalLabel">Print Preview - Forwarding Letter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="accountOpeningLetterPrint">
                    <ReportLayout>

                        <section class="report-recipient">
                            <p><strong>Issue Date:</strong> @printGeneratedAt.ToString("dd MMMM yyyy")</p>
                            <br />
                            <p class="mb-0">To</p>
                            <p class="mb-0">The Branch Manager</p>
                            <p class="mb-0">Brac Bank</p>
                            <p class="mb-0">Banani Branch, Dhaka</p>
                        </section>

                        <section class="report-subject">
                            <p class=""><strong>Subject:</strong> Forwarding of Documents for Opening Salary Accounts of Newly Appointed Employees</p>
                        </section>

                        <section class="report-body-section">
                            <p>Dear Sir,</p>
                            <p>We are forwarding herewith the account opening forms and required documents of the following newly appointed employees of <strong>JB Connect Ltd</strong>, who have recently joined our organization.</p>
                            <p>Kindly open <strong>Salary Accounts</strong> in their names and share the account details upon activation.</p>
                        </section>

                        <section class="report-body-section">
                            <table class="table table-bordered report-table">
                                <thead>
                                    <tr>
                                        <th scope="col">SL</th>
                                        <th scope="col">ID</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Designation</th>
                                        <th scope="col">Joining Date</th>
                                        <th scope="col">Salary (BDT)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (printEmployees.Any())
                                    {
                                        @for (var index = 0; index < printEmployees.Count; index++)
                                        {
                                            var employee = printEmployees[index];
                                            <tr>
                                                <td>@(index + 1)</td>
                                                <td>@employee.EmployeeID</td>
                                                <td>@employee.Salutation @employee.FirstName @employee.LastName</td>
                                                <td>@employee.Designation</td>
                                                <td>@employee.JoiningDate.ToString("dd MMM yyyy")</td>
                                                <td class="text-center">@employee.Gross.ToString("N0")</td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr class="report-row-empty">
                                            <td colspan="6" class="text-center">No employees selected.</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </section>

                        <section class="report-closing">
                            <p>Kindly do the needful and confirm once the accounts have been opened. Thanking you for your co-operation.</p>
                            <p>Regards,</p>
                        </section>

                        <section class="report-signature">
                            <p class="mb-0">Tanzima Chowdhury</p>
                            <p class="mb-0">Manager (HR &amp; Admin)</p>
                            <p class="mb-0">JB Connect Ltd.</p>
                            <p class="mb-0">Phone: +8801601699646</p>
                            <p class="mb-0">Email: hr@jbc-ltd.com</p>
                        </section>

                    </ReportLayout>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="ConfirmPrint">
                    <i class="bi bi-printer"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private const string FileInputId = "accountLetterFileInput";
    private List<Employee>? employees;
    private bool dataTableInitialized = false;
    private DotNetObjectReference<ForwardingLetter>? dotNetReference;
    private HashSet<Employee> selectedEmployees = new HashSet<Employee>();
    private bool allChecked = false;
    private List<Employee> printEmployees = new();
    private DateTime printGeneratedAt = DateTime.Now;
    private string? importError;

    protected override void OnInitialized()
    {
        dotNetReference = DotNetObjectReference.Create(this);
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadFromLocalStorage();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!dataTableInitialized && employees != null && employees.Any())
        {
            await JSRuntime.InvokeVoidAsync("initDataTable", "accountLetterTable");
            dataTableInitialized = true;
        }
    }

    private async Task ChooseFile()
    {
        await JSRuntime.InvokeVoidAsync("openFileDialog", FileInputId);
    }

    private async Task HandleFileChange()
    {
        if (dotNetReference is null)
        {
            return;
        }

        await JSRuntime.InvokeVoidAsync("readFile", FileInputId, dotNetReference);
    }

    private async Task SaveToLocalStorage()
    {
        if (employees != null)
        {
            var json = JsonSerializer.Serialize(employees);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "employees", json);
        }
    }

    private async Task LoadFromLocalStorage()
    {
        importError = null;
        var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "employees");
        if (!string.IsNullOrEmpty(json))
        {
            employees = JsonSerializer.Deserialize<List<Employee>>(json);
        }
    }

    [JSInvokable]
    public async Task ReceiveFileContent(string content, string fileName)
    {
        try
        {
            using var csv = new CsvReader(new StringReader(content), CultureInfo.InvariantCulture);
            employees = csv.GetRecords<Employee>().ToList();
            selectedEmployees.Clear();
            allChecked = false;
            printEmployees.Clear();
            importError = null;
            await SaveToLocalStorage();
            dataTableInitialized = false;
        }
        catch (Exception ex)
        {
            importError = $"Unable to process CSV: {ex.Message}";
        }

        await InvokeAsync(StateHasChanged);
    }

    private bool GetEmployeeSelection(Employee employee)
    {
        return selectedEmployees.Contains(employee);
    }

    private void SetEmployeeSelection(Employee employee, bool isSelected)
    {
        if (isSelected)
        {
            selectedEmployees.Add(employee);
        }
        else
        {
            selectedEmployees.Remove(employee);
        }
        UpdateAllCheckedState();
        StateHasChanged();
    }

    private void ToggleAllCheckboxes()
    {
        if (employees == null) return;

        if (allChecked)
        {
            selectedEmployees.Clear();
            allChecked = false;
        }
        else
        {
            selectedEmployees.Clear();
            foreach (var emp in employees)
            {
                selectedEmployees.Add(emp);
            }
            allChecked = true;
        }
        StateHasChanged();
    }

    private void UpdateAllCheckedState()
    {
        if (employees == null || employees.Count == 0)
        {
            allChecked = false;
            return;
        }

        allChecked = employees.All(emp => selectedEmployees.Contains(emp));
    }

    private async Task PrintSelectedLetters()
    {
        if (employees == null || !selectedEmployees.Any())
        {
            return;
        }

        printGeneratedAt = DateTime.Now;
        printEmployees = employees
            .Where(emp => selectedEmployees.Contains(emp))
            .OrderByDescending(emp => emp.JoiningDate)
            .ToList();

        await InvokeAsync(StateHasChanged);
        await Task.Delay(50);
        await JSRuntime.InvokeVoidAsync("showModal", "printPreviewModal");
    }

    private async Task ConfirmPrint()
    {
        await JSRuntime.InvokeVoidAsync("hideModal", "printPreviewModal");
        await Task.Delay(100);
    await JSRuntime.InvokeVoidAsync("printReport", "accountOpeningLetterPrint", "Forwarding Letter");
    }

    private void HandleCheckboxChange(Employee employee, ChangeEventArgs e)
    {
        bool isChecked = e.Value is bool value && value;
        SetEmployeeSelection(employee, isChecked);
    }

    public void Dispose()
    {
        dotNetReference?.Dispose();
    }
}